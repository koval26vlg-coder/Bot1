# Арбитражный бот (демо-версия для треугольного арбитража)

Проект демонстрирует минимально жизнеспособный прототип арбитражного бота с упором на треугольный арбитраж. Код предоставляет единый CLI (`main.py`), упрощённый движок и воспроизведение исторических данных для стресс-тестов. Все основные компоненты собраны в одном модуле `arbitrage_bot.py`, что облегчает ознакомление с ключевыми интерфейсами и точкой входа.

## Основные возможности
- Четыре режима запуска через CLI: `standard`, `aggressive`, `quick` и `replay` (исторический прогон CSV).
- Генерация синтетических арбитражных возможностей и отчётов о выполненных сделках.
- Имитация выставления сделок с учётом периода охлаждения (`COOLDOWN_PERIOD`).
- Быстрый тестовый цикл в режиме `quick` с кастомными порогами прибыли и объёмом сделки.
- Простое воспроизведение CSV-файла с котировками для стресс-теста логики (`HistoricalReplayer`).
- Единообразное логирование с контекстом режима, окружения и идентификатора цикла.

## Структура репозитория
- `main.py` — CLI-обёртка, маршрутизирующая запуск по выбранному режиму и применяющая переменные окружения.
- `arbitrage_bot.py` — монолитный модуль с конфигурацией (`OptimizedConfig`), движком (`AdvancedArbitrageEngine`), воспроизведением истории (`HistoricalReplayer`) и функцией запуска `run_advanced_bot`.
- `pyproject.toml` — метаданные пакета и список зависимостей (Python ≥ 3.10).
- `requirements.txt` — фиксированные версии внешних библиотек.
- `SECURITY.md` — политика ответственного раскрытия уязвимостей.

## Установка
1. Убедитесь, что установлен Python 3.10 или новее.
2. Создайте виртуальное окружение и активируйте его:
   ```bash
   python -m venv .venv
   # Windows (PowerShell)
   .\.venv\Scripts\activate
   # Linux/macOS
   # source .venv/bin/activate
   ```
3. Установите зависимости (можно через editable-режим для разработки):
   ```bash
   pip install -r requirements.txt
   # или
   pip install -e .
   ```

При ограниченном доступе к интернету скачайте зависимости заранее (см. пример в блоке «Загрузка из wheelhouse» ниже).

## Быстрый старт
Стандартный запуск в продакшн-конфигурации:
```bash
python main.py --mode standard
```
В логах появятся сообщения о запуске бота, найденных возможностях и итоговом отчёте по сделкам.

## Режимы CLI
`main.py` поддерживает четыре режима (аргумент `--mode`):
- **standard** — базовый запуск упрощённого движка с настройками по умолчанию.
- **aggressive** — включает тестнет и симуляцию, снижает порог прибыли до `0.01`, позволяет переопределять параметры через CLI.
- **quick** — короткий тестовый цикл (три итерации) с использованием `OptimizedConfig` и пользовательских порогов.
- **replay** — воспроизведение CSV с историческими котировками для стресс-теста логики.

### Аргументы CLI
| Аргумент | Описание |
| --- | --- |
| `--mode` | Выбор режима: `standard`, `aggressive`, `quick`, `replay`. |
| `--min-profit` | Пользовательский порог прибыли (`MIN_TRIANGULAR_PROFIT`). |
| `--trade-amount` | Объём сделки для тестовых прогонов (`TRADE_AMOUNT`). |
| `--log-level` | Уровень логирования (`INFO`, `DEBUG` и т.д.). |
| `--replay-path` | Путь к CSV-файлу с историческими данными для режима `replay`. |
| `--replay-speed` | Коэффициент ускорения воспроизведения истории. |
| `--replay-limit` | Ограничение числа обрабатываемых записей из CSV. |

### Примеры запуска
```bash
# Стандартный режим с логами уровня INFO
python main.py --mode standard

# Агрессивный режим с кастомным порогом прибыли и объёмом сделки
python main.py --mode aggressive --min-profit 0.02 --trade-amount 50

# Быстрый тестовый цикл с повышенным логированием
python main.py --mode quick --log-level DEBUG

# Replay исторических котировок с ускорением в 4 раза и ограничением 10 000 строк
python main.py --mode replay --replay-path data/bybit_ticks.csv --replay-speed 4 --replay-limit 10000
```

## Конфигурация и переменные окружения
`main.py` динамически применяет переменные окружения в зависимости от режима. Основные параметры:
- `MIN_TRIANGULAR_PROFIT` — минимальная прибыль для фиктивных возможностей (переопределяется через `--min-profit`).
- `TRADE_AMOUNT` — объём сделки в USDT (переопределяется через `--trade-amount`).
- `TESTNET` — переключение на тестовую среду (включено по умолчанию в `aggressive` и `quick`).
- `SIMULATION_MODE` — включает симуляцию без реальных ордеров (автоматически в `aggressive` и `replay`).
- `PAPER_TRADING_MODE` — эмуляция стакана для безопасных прогонов (включается в `replay`).

Дополнительные параметры из `OptimizedConfig` (см. `arbitrage_bot.py`):
- `COOLDOWN_PERIOD` — пауза между повторными сделками по одному треугольнику.
- `MARKET_SNAPSHOT_SYMBOLS` — сколько тикеров выводить в кратком срезе рынка.
- `REPLAY_DATA_PATH`, `REPLAY_SPEED`, `REPLAY_MAX_RECORDS` — настройки для `HistoricalReplayer`.

## Логирование
Логи унифицированы функцией `configure_root_logging` и обогащаются контекстом (`mode`, `environment`, `cycle_id`) через `create_adapter`. При запуске ожидайте сообщения о старте, найденных возможностях, выполненных сделках и итоговой статистике (`get_triangle_performance_report`).

## Как работает движок
- `AdvancedArbitrageEngine.detect_opportunities()` — генерирует синтетические возможности с учётом `MIN_TRIANGULAR_PROFIT`.
- `execute_arbitrage()` — имитирует исполнение сделки и записывает её в историю с таймером охлаждения.
- `_fake_market_snapshot()` — собирает небольшой срез котировок для демонстрации вывода.
- `HistoricalReplayer.replay()` — построчно читает CSV и логирует прогресс с учётом `speed` и `max_records`.
- `run_advanced_bot()` — объединяет поиск возможностей, выполнение сделок, вывод среза рынка и финальный отчёт.

## Загрузка зависимостей без интернета
```bash
pip download --dest wheelhouse --no-deps setuptools>=69
pip download --dest wheelhouse -r requirements.txt
pip install --no-index --find-links=wheelhouse setuptools>=69
pip install --no-index --find-links=wheelhouse -r requirements.txt
```

## Тестирование
Автоматические тесты в репозитории отсутствуют. Для быстрой проверки корректности синтаксиса можно запустить:
```bash
python -m py_compile main.py arbitrage_bot.py
```

## Ответственное раскрытие
Смотрите `SECURITY.md` для инструкции по сообщению об уязвимостях и каналу связи.

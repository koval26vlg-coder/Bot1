# Algorithmic Trading Bot (Bybit Triangular Arbitrage)

Текущая версия проекта сфокусирована на треугольном арбитраже на Bybit с единым CLI и минимальным набором поддерживаемых модулей. Вся логика построена вокруг получения котировок, отбора топовых инструментов, оценки связок и контролируемого исполнения сделок.

## Структура проекта

- `main.py` — единый CLI для выбора режима запуска.
- `advanced_bot.py` — оболочка над движком с мониторингом и логированием.
- `advanced_arbitrage_engine.py` — ядро поиска и оценки арбитражных возможностей.
- `bybit_client.py` — REST/WebSocket-клиент для котировок и ордеров.
- `config.py` — конфигурация по умолчанию, загрузка и отбор инструментов.
- `indicator_strategies.py` — набор индикаторов и фильтров для сигналов.
- `real_trading.py` — исполнение сделок и расчёт параметров ордеров.
- `performance_optimizer.py` — оптимизация параметров и профилирование циклов.
- `monitoring.py` — сбор системных метрик и экспорт состояния.
- `math_stats.py` — статистические утилиты для анализа данных.
- `requirements.txt` — список необходимых зависимостей.

## Режимы запуска через CLI

`main.py` предоставляет три режима работы, переключаемые через параметр `--mode`:

- `standard` — базовый запуск улучшенного бота.
- `aggressive` — включает тестнет и симуляцию, по умолчанию снижает `MIN_TRIANGULAR_PROFIT` до `0.01` и позволяет переопределять пороги через параметры CLI.
- `quick` — быстрый тестовый прогон с `OptimizedConfig` и тремя циклами поиска возможностей без выхода в продакшн.
- `replay` — стресс-тест на исторических данных (CSV) с paper trading и эмуляцией стакана.

Примеры:

```bash
# Стандартный режим
python main.py --mode standard

# Агрессивный режим с кастомным порогом прибыли и суммой сделки
python main.py --mode aggressive --min-profit 0.01 --trade-amount 25

# Быстрый тестовый прогон с повышенным логированием
python main.py --mode quick --log-level DEBUG

# Replay с историческими данными (ускорение в 4 раза)
python main.py --mode replay --replay-path data/bybit_ticks.csv --replay-speed 4
```

Основные параметры:
- `--mode` — `standard`, `aggressive`, `quick` или `replay`.
- `--min-profit` — порог прибыли `MIN_TRIANGULAR_PROFIT`.
- `--trade-amount` — сумма сделки для тестовых прогонов.
- `--log-level` — уровень логирования.
- `--replay-path` — путь к CSV с полями `timestamp,symbol,bid,ask,bid_size,ask_size,last_price,volume`.
- `--replay-speed` — ускорение воспроизведения исторических данных.
- `--replay-limit` — ограничение числа строк для быстрого стресс-теста.

### Выбор биржи

По умолчанию бот использует Bybit. Для работы с котировками OKX задайте переменную окружения `PRIMARY_EXCHANGE=okx`. В этом случае подключение и треугольники строятся по тикерам OKX, а функции выставления/отмены ордеров остаются в режиме заглушек (для симуляции и анализа без риска).

## Отбор доступных инструментов

При старте конфигурация запрашивает список доступных инструментов через публичный REST Bybit, сортирует их по 24-часовому обороту и возвращает полный перечень. При необходимости можно задать лимит через переменную окружения `MARKET_SYMBOLS_LIMIT` (0 — без ограничений). Даже при использовании статических шаблонов треугольников список наблюдаемых тикеров фильтруется по реально доступным инструментам в выбранной категории рынка.

## Установка

```bash
python -m venv .venv
. .venv/Scripts/activate  # Windows (PowerShell)
# source .venv/bin/activate  # Linux/macOS

pip install -r requirements.txt
```

Обязательно выполните установку зависимостей: пакет `psutil==6.1.0` входит в список обязательных и отвечает за сбор системных метрик. Без него мониторинг ресурсов и алерты не будут работать.

### Запуск тестов

`pytest` включён в базовый `requirements.txt`, поэтому после установки зависимостей тесты запускаются без дополнительной подготовки:

```bash
python -m pytest
```

### ML-оптимизация порогов

Функции динамического ML-подбора порога прибыли используют `scikit-learn`, который временно вынесен в отдельный профиль зависимостей, чтобы не ломать установку на Python 3.13 (на момент написания бинарные колёса для этой версии отсутствуют).

```bash
# Установка опциональной ML-зависимости (Python 3.12 и ниже)
pip install -r requirements-ml.txt
```

Если `scikit-learn` не установлен или несовместим, бот автоматически залогирует предупреждение и продолжит работу с фолбэк-порогом `ML_FALLBACK_THRESHOLD`/`MIN_TRIANGULAR_PROFIT` без аварийного завершения CLI.

### Переменные окружения

Для удобной работы со значениями API-ключей используется пакет `python-dotenv`. Создайте файл `.env` в корне проекта и пропишите, например:

```
BYBIT_API_KEY="ваш_ключ"
BYBIT_API_SECRET="ваш_секрет"
TESTNET=True
```

При запуске `load_dotenv()` автоматически подтянет эти значения, поэтому важно установить зависимости из `requirements.txt`.

Дополнительные параметры:

- `PAPER_TRADING_MODE=true` включает paper trading с эмуляцией стакана.
- `PAPER_BOOK_IMPACT=0.05` настраивает ценовое влияние при нехватке ликвидности в симуляции.
- `WEBSOCKET_PRICE_ONLY=true` заставляет использовать только WebSocket-котировки без REST-фолбэка.
- `ENABLE_ASYNC_MARKET_CLIENT=true` по умолчанию активирует асинхронный сбор котировок через `AsyncBybitClient`.
- `USE_LEGACY_TICKER_CLIENT=true` принудительно откатывает бота к старому синхронному клиенту, если требуется постепенный переход.
- `REPLAY_DATA_PATH=/path/to/bybit_ticks.csv` задаёт файл для режима `replay`.
- `REPLAY_SPEED=4` и `REPLAY_MAX_RECORDS=10000` управляют скоростью и объёмом стресс-теста на истории.
- `MARKET_SYMBOLS_LIMIT=50` позволяет ограничить количество загружаемых тикеров, оставив сортировку по обороту.
